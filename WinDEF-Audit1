# Detection: Check if Defender security features are enabled
# Exit 0 = compliant, Exit 1 = remediation needed

$ErrorActionPreference = "Stop"
$regPath = "HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios"
$defenderPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"

$checks = @{
    "Memory Integrity (HVCI)" = @{
        Path = "$regPath\HypervisorEnforcedCodeIntegrity"
        Value = "Enabled"
        Expected = 1
    }
    "Kernel-mode Stack Protection (KHSP)" = @{
        Path = "$regPath\HypervisorEnforcedCodeIntegrity"
        Value = "HypervisorManagedCodeIntegrityState"
        Expected = 1
    }
    "Firmware Protection" = @{
        Path = "$regPath\HypervisorEnforcedCodeIntegrity"
        Value = "HypervisorManagedCodeIntegrityState"
        Expected = 1
    }
    "Vulnerable Driver Blocklist" = @{
        Path = "$defenderPath"
        Value = "DisableVulnerableDriverBlocklist"
        Expected = 0
    }
}

$allCompliant = $true

try {
    Write-Host "[DETECT] Checking Defender security features..."

    foreach ($check in $checks.GetEnumerator()) {
        $name = $check.Key
        $path = $check.Value.Path
        $value = $check.Value.Value
        $expected = $check.Value.Expected

        try {
            $regValue = Get-ItemProperty -Path $path -Name $value -ErrorAction SilentlyContinue
            
            if ($null -eq $regValue) {
                Write-Host "[DETECT] ✗ $name - Registry value not found"
                $allCompliant = $false
            }
            elseif ($regValue.$value -eq $expected) {
                Write-Host "[DETECT] ✓ $name - Enabled (Value: $($regValue.$value))"
            }
            else {
                Write-Host "[DETECT] ✗ $name - Disabled (Expected: $expected, Got: $($regValue.$value))"
                $allCompliant = $false
            }
        }
        catch {
            Write-Host "[DETECT] ✗ $name - Error reading registry: $_"
            $allCompliant = $false
        }
    }

    if ($allCompliant) {
        Write-Host "[DETECT] SUCCESS: All Defender security features are compliant"
        exit 0
    }
    else {
        Write-Host "[DETECT] FAIL: Some features are not enabled"
        exit 1
    }
}
catch {
    Write-Host "[DETECT] ERROR: $_"
    exit 1
}
